import { Meta } from '@storybook/addon-docs'

<Meta title="Advanced topics/Add subscriber hook" />

# Add subscriber hook

Promoted cells in Pocota is not rendered directly
where they are defined when the table is rotated. They are
sneaked out of their initial place, and spit out again
elsewhere. More specifically, they are rendered from the
surrounding `Thead` or `Tr` tag. To keep this article
shorter, will only describe the relation between `Td` and
`Tr`, but the same applies for the relation between `Th`
and `Thead` as well!

```tsx
{
  // From Tr
}
;<tr {...props}>
  {front != null && <td>{front}</td>}
  <td>
    <dl>{props.children}</dl>
  </td>
  {back.map((content, i) => (
    <td key={i}>{content}</td>
  ))}
</tr>
```

One of the problems of doing it like this, is that when the
table cell re-render, the `Thead` or `Tr` is not. That is why we
need to "add a subscriber". The subscriber should be a
function that alters the state of `Tr`, when a `Td` is re-rendered
(whenever a `Td`'s state or props is altered).

The magic and simplicity of this pattern, is that whenever a
`Td` is re-rendered, it calls the useSubscribeForRender hook,
and the hook itself makes sure to call this subscriber
whenever either props.children is altered, or the subscriber
itself.

So the subscriber has the responsibility of updating `Tr`'s
state whenever one of it's promoted children has changed.
The `useSubscribeForRender` hook has two tasks: Provide a
function `addSubscriber: AddSubscriber`, and making sure
that the subscribers are called on re-render.

## A note regarding having functions in state

A common hole I also fell into when making this hook, was the
fact that whenever `useState` is served a function, it calls
this function and uses the return value as state value.
Therefore, whenever I set state in `useSubscribeForRender` I
add an extra layer of lambda outside of the interesting fn.
This makes the code somewhat harder to understand, unless you
know about this pitfall yourself. Now you do. ðŸ˜Š
